<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K8s 命令学习笔记 - 弓长笔记</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="jincheng9" /><meta name="description" content="容器编排的故事 容器编排 Docker Swarm Mesos Kubernets Google 关停自家容器项目 lmctfy，打算和 Docker 公司共同推进一个中立的容器运行时库作为 Docker 项目的核心依赖。 不过，Dock" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="http://blog.gongchang.me/post/k8s-%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="K8s 命令学习笔记" />
<meta property="og:description" content="容器编排的故事 容器编排 Docker Swarm Mesos Kubernets Google 关停自家容器项目 lmctfy，打算和 Docker 公司共同推进一个中立的容器运行时库作为 Docker 项目的核心依赖。 不过，Dock" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.gongchang.me/post/k8s-%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-02T23:09:31+08:00" />
<meta property="article:modified_time" content="2022-01-02T23:09:31+08:00" />

<meta itemprop="name" content="K8s 命令学习笔记">
<meta itemprop="description" content="容器编排的故事 容器编排 Docker Swarm Mesos Kubernets Google 关停自家容器项目 lmctfy，打算和 Docker 公司共同推进一个中立的容器运行时库作为 Docker 项目的核心依赖。 不过，Dock"><meta itemprop="datePublished" content="2022-01-02T23:09:31+08:00" />
<meta itemprop="dateModified" content="2022-01-02T23:09:31+08:00" />
<meta itemprop="wordCount" content="9563">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s 命令学习笔记"/>
<meta name="twitter:description" content="容器编排的故事 容器编排 Docker Swarm Mesos Kubernets Google 关停自家容器项目 lmctfy，打算和 Docker 公司共同推进一个中立的容器运行时库作为 Docker 项目的核心依赖。 不过，Dock"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">弓长笔记</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">全部文章</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">弓长笔记</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">全部文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K8s 命令学习笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-02 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#容器编排的故事">容器编排的故事</a></li>
    <li><a href="#kubenetesk8s简介">Kubenetes（K8S）简介</a>
      <ul>
        <li><a href="#和传统部署方式对比">和传统部署方式对比</a></li>
        <li><a href="#什么时候需要-kubernetes-">什么时候需要 Kubernetes ？</a></li>
        <li><a href="#kubenetes-环境搭建">Kubenetes 环境搭建</a>
          <ul>
            <li><a href="#minikube">Minikube</a></li>
          </ul>
        </li>
        <li><a href="#kubeadm--kubectl--kubelet-区别">kubeadm &amp; kubectl &amp; kubelet 区别</a></li>
      </ul>
    </li>
    <li><a href="#kubectl-基础使用">kubectl 基础使用</a>
      <ul>
        <li><a href="#pod--deployment-管理命令">pod &amp; deployment 管理命令</a></li>
        <li><a href="#service-管理命令">service 管理命令</a></li>
        <li><a href="#pod--deployment--statefulset-的关系">Pod &amp; Deployment &amp; StatefulSet 的关系</a></li>
      </ul>
    </li>
    <li><a href="#资源-yaml-文件编写说明">资源 yaml 文件编写说明</a>
      <ul>
        <li><a href="#pod-资源">Pod 资源</a></li>
        <li><a href="#deployment-资源">Deployment 资源</a></li>
        <li><a href="#statefulset-资源">StatefulSet 资源</a>
          <ul>
            <li><a href="#数据持久化-hostpath-不推荐使用">数据持久化 HostPath 不推荐使用</a></li>
            <li><a href="#storage-class-sc">Storage Class (SC)</a></li>
            <li><a href="#persistent-volume-pv">Persistent Volume (PV)</a></li>
            <li><a href="#persistent-volume-claim-pvc-申请单">Persistent Volume Claim (PVC) 申请单</a></li>
            <li><a href="#本地磁盘示例">本地磁盘示例</a></li>
          </ul>
        </li>
        <li><a href="#daemonset-资源">DaemonSet 资源</a></li>
        <li><a href="#job--cronjob-资源">Job &amp; CronJob 资源</a></li>
        <li><a href="#service-资源">Service 资源</a></li>
        <li><a href="#configmap--secret-资源">ConfigMap &amp; Secret 资源</a>
          <ul>
            <li><a href="#作为环境变量使用">作为环境变量使用</a></li>
            <li><a href="#挂载为文件更适合证书文件">挂载为文件（更适合证书文件）</a></li>
          </ul>
        </li>
        <li><a href="#helm--命名空间">Helm &amp; 命名空间</a></li>
        <li><a href="#ingress-提供统一访问入口">Ingress 提供统一访问入口</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="容器编排的故事">容器编排的故事</h1>
<p>容器编排</p>
<ul>
<li>Docker Swarm</li>
<li>Mesos</li>
<li>Kubernets</li>
</ul>
<p>Google 关停自家容器项目 lmctfy，打算和 Docker 公司共同推进一个中立的容器运行时库作为 Docker 项目的核心依赖。</p>
<p>不过，Docker 公司并没有认同这个明显会削弱自己地位的提议，还在不久后，自己发布了一个容器运行时库 Libcontainer。这次匆忙的、由一家主导的、并带有战略性考量的重构，成了 Libcontainer 被社区长期诟病代码可读性差、可维护性不强的一个重要原因。</p>
<p>Docker 的一系列不稳定开始让社区叫苦不迭。</p>
<p>于是，2015 年 6 月 22 日，由 Docker 公司牵头，CoreOS、Google、RedHat 等公司共同宣布，Docker 公司将 Libcontainer 捐出，并改名为 RunC 项目，交由一个完全中立的基金会管理，然后以 RunC 为依据，大家共同制定一套容器和镜像的标准和规范。</p>
<p>这套标准和规范，就是 OCI（ Open Container Initiative ）。OCI 的提出，意在将容器运行时和镜像的实现从 Docker 项目中完全剥离出来。这样做，一方面可以改善 Docker 公司在容器技术上一家独大的现状，另一方面也为其他玩家不依赖于 Docker 项目构建各自的平台层能力提供了可能。</p>
<p>但是 OCI 并没能改变 Docker 公司在容器领域一家独大的现状，Google 和 RedHat 等公司于是把与第二把武器摆上了台面。</p>
<p>这次，Google、RedHat 等开源基础设施领域玩家们，共同牵头发起了一个名为 CNCF（Cloud Native Computing Foundation）的基金会。这个基金会的目的其实很容易理解：它希望，以 Kubernetes 项目为基础，建立一个由开源基础设施领域厂商主导的、按照独立基金会方式运营的平台级社区，来对抗以 Docker 公司为核心的容器商业生态。</p>
<p>CNCF 社区就需要至少确保两件事情：</p>
<ol>
<li>Kubernetes 项目必须能够在容器编排领域取得足够大的竞争优势；</li>
<li>CNCF 社区必须以 Kubernetes 项目为核心，覆盖足够多的场景。</li>
</ol>
<p>我们先来看看 CNCF 社区如何解决 Kubernetes 项目在编排领域的竞争力的问题。</p>
<p>在容器编排领域，Kubernetes 项目需要面对来自 Docker 公司和 Mesos 社区两个方向的压力。不难看出，Swarm 和 Mesos 实际上分别从两个不同的方向讲出了自己最擅长的故事：Swarm 擅长的是跟 Docker 生态的无缝集成，而 Mesos 擅长的则是大规模集群的调度与管理。</p>
<p>Kubernetes 选择的应对方式是：Borg。为什么 Kubernetes 发布后，很多人“抱怨”其设计思想过于“超前”的原因：Kubernetes 项目的基础特性，并不是几个工程师突然“拍脑袋”想出来的东西，而是 Google 公司在容器化基础设施领域多年来实践经验的沉淀与升华。这，正是 Kubernetes 项目能够从一开始就避免同 Swarm 和 Mesos 社区同质化的重要手段。</p>
<p>面对 Kubernetes 社区的崛起和壮大，Docker 公司也不得不面对自己豪赌失败的现实。所以，从 2017 年开始，Docker 公司先是将 Docker 项目的容器运行时部分 Containerd 捐赠给 CNCF 社区，标志着 Docker 项目已经全面升级成为一个 PaaS 平台；紧接着，Docker 公司宣布将 Docker 项目改名为 Moby，然后交给社区自行维护，而 Docker 公司的商业产品将占有 Docker 这个注册商标。</p>
<p>Docker 公司这些举措背后的含义非常明确：它将全面放弃在开源社区同 Kubernetes 生态的竞争，转而专注于自己的商业业务，并且通过将 Docker 项目改名为 Moby 的举动，将原本属于 Docker 社区的用户转化成了自己的客户。</p>
<p>容器，其实是一种特殊的进程而已。</p>
<p>最具代表性的容器编排工具，当属 Docker 公司的 Compose+Swarm 组合，以及 Google 与 RedHat 公司共同主导的 Kubernetes 项目。</p>
<p>而计算节点上最核心的部分，则是一个叫作 kubelet 的组件。</p>
<p>在 Kubernetes 项目中，kubelet 主要负责同容器运行时（比如 Docker 项目）打交道。而这个交互所依赖的，是一个称作 CRI（Container Runtime Interface）的远程调用接口，这个接口定义了容器运行时的各项核心操作，比如：启动一个容器需要的所有参数。</p>
<p>而kubelet 的另一个重要功能，则是调用网络插件和存储插件为容器配置网络和持久化存储。这两个插件与 kubelet 进行交互的接口，分别是 CNI（Container Networking Interface）和 CSI（Container Storage Interface）。</p>
<p>所以从一开始，Kubernetes 项目就没有像同时期的各种“容器云”项目那样，把 Docker 作为整个架构的核心，而仅仅把它作为最底层的一个容器运行时实现。</p>
<h1 id="kubenetesk8s简介">Kubenetes（K8S）简介</h1>
<p>它是一个为 容器化 应用提供集群部署和管理的开源工具，由 Google 开发。</p>
<p>Kubernetes 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。 Google 在 2014 年开源了 Kubernetes 项目</p>
<p>主要特性：</p>
<ul>
<li>高可用，不宕机，自动灾难恢复</li>
<li>灰度更新，不影响业务正常运转</li>
<li>一键回滚到历史版本</li>
<li>方便的伸缩扩展（应用伸缩，机器加减）、提供负载均衡</li>
<li>有一个完善的生态</li>
</ul>
<h2 id="和传统部署方式对比">和传统部署方式对比</h2>
<p><img src="/img/k8s_1.png" alt=""></p>
<ul>
<li>
<p><strong>传统部署方式</strong>：应用直接在物理机上部署，机器资源分配不好控制，出现Bug时，可能机器的大部分资源被某个应用占用，导致其他应用无法正常运行，无法做到应用隔离。</p>
</li>
<li>
<p><strong>虚拟机部署</strong>：在单个物理机上运行多个虚拟机，每个虚拟机都是完整独立的系统，性能损耗大。</p>
</li>
<li>
<p><strong>容器部署</strong>：所有容器共享主机的系统，轻量级的虚拟机，性能损耗小，资源隔离，CPU和内存可按需</p>
</li>
</ul>
<p>其实最主要的还是方便，容器制作根文件系统后，把软件的依赖类库全部安装进去了。不需要每次重复工作。</p>
<h2 id="什么时候需要-kubernetes-">什么时候需要 Kubernetes ？</h2>
<p>当你的应用只是跑在一台机器，直接一个 docker + docker-compose 就够了，方便轻松；</p>
<p>当你的应用需要跑在 3，4 台机器上，你依旧可以每台机器单独配置运行环境 + 负载均衡器；</p>
<p>当你应用访问数不断增加，机器逐渐增加到十几台、上百台、上千台时，每次加机器、软件更新、版本回滚，都会变得非常麻烦、痛不欲生，再也不能好好的摸鱼了，人生浪费在那些没技术含量的重复性工作上。</p>
<p>这时候，Kubernetes 就可以一展身手了，让你轻松管理百万千万台机器的集群。加机器、版本升级、版本回滚，那都是一个命令就搞定的事，不停机的灰度更新，确保高可用、高性能、高扩展。</p>
<p><strong>Kubernetes 集群架构</strong></p>
<p><img src="/img/k8s_3.png" alt=""></p>
<p>master</p>
<ul>
<li>主节点，控制平台，不需要很高性能，不跑任务，通常一个就行了，也可以开多个主节点来提高集群可用度。</li>
</ul>
<p>worker</p>
<ul>
<li>工作节点，可以是虚拟机或物理计算机，任务都在这里跑，机器性能需要好点；通常都有很多个，可以不断加机器扩大集群；每个工作节点由主节点管理</li>
</ul>
<p><strong>重要概念 Pod</strong></p>
<p>豆荚，K8S 调度、管理的最小单位，一个 Pod 可以包含一个或多个容器，每个 Pod 有自己的虚拟IP。一个工作节点可以有多个 pod，主节点会考量负载自动调度 pod 到哪个节点运行。</p>
<p><img src="/img/k8s_1.jpg" alt=""></p>
<p>Kubernetes 组件</p>
<ul>
<li>kube-apiserver API 服务器，公开了 Kubernetes API</li>
<li>etcd 键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库</li>
<li>kube-scheduler 调度 Pod 到哪个节点运行</li>
<li>kube-controller 集群控制器</li>
<li>cloud-controller 与云服务商交互</li>
</ul>
<p><img src="/img/k8s_2.png" alt=""></p>
<p>官网详细介绍：https://kubernetes.io/zh/docs/concepts/overview/components/</p>
<h2 id="kubenetes-环境搭建">Kubenetes 环境搭建</h2>
<ul>
<li>
<p>minikube</p>
<ul>
<li>只是一个 K8S 集群模拟器，只有一个节点的集群，只为测试用，master 和 worker 都在一起</li>
</ul>
</li>
<li>
<p>直接用云平台 Kubernetes</p>
<ul>
<li>可视化搭建，只需简单几步就可以创建好一个集群。优点：安装简单，生态齐全，负载均衡器、存储等都给你配套好，简单操作就搞定</li>
</ul>
</li>
<li>
<p>裸机安装（Bare Metal）</p>
<ul>
<li>至少需要两台机器（主节点、工作节点个一台），需要自己安装 Kubernetes 组件，配置会稍微麻烦点。</li>
<li>可以到各云厂商按时租用服务器，费用低，用完就销毁。</li>
<li>缺点：配置麻烦，缺少生态支持，例如负载均衡器、云存储。</li>
</ul>
</li>
</ul>
<h3 id="minikube">Minikube</h3>
<p>安装教程：https://minikube.sigs.k8s.io/docs/start/</p>
<p>如果执行 minikube start 报错如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exiting due to DRV_AS_ROOT: The “docker“ driver should not be used with root privileges.
</span></span></code></pre></td></tr></table>
</div>
</div><p>则换一种方式启动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ minikube start --force --driver=docker
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="kubeadm--kubectl--kubelet-区别">kubeadm &amp; kubectl &amp; kubelet 区别</h2>
<p><strong>kubeadm</strong></p>
<p>是官方社区推出的一个用于快速部署kubernetes集群的工具。这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<p>官网地址：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">点我传送</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 创建一个 Master 节点
</span></span><span class="line"><span class="cl">$ kubeadm init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将一个 Node 节点加入到当前集群中
</span></span><span class="line"><span class="cl">$ kubeadm join &lt;Master节点的IP和端口 &gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>kubectl</strong></p>
<p>kubectl 是管理 Kubernetes 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能够在集群上进行容器化应用的安装和部署。</p>
<p><strong>kubelet</strong></p>
<p>master 派到 node节点的代表，管理本机容器。</p>
<ul>
<li>一个集群中每个节点上运行的代理，它保证容器都运行在 Pod 中</li>
<li>负责维护容器的生命周期，同时也负责Volume(CSI) 和 网络(CNI)的管理</li>
</ul>
<h1 id="kubectl-基础使用">kubectl 基础使用</h1>
<p>用命令行创建第一个 pod，名字为 testapp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get pod
</span></span><span class="line"><span class="cl">No resources found in default namespace.
</span></span><span class="line"><span class="cl">$ kubectl run testapp --image=ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1
</span></span><span class="line"><span class="cl">pod/testapp created
</span></span><span class="line"><span class="cl">$ kubectl get pod
</span></span><span class="line"><span class="cl">NAME      READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">testapp   0/1     ContainerCreating   0          5
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到 testapp 还没运行起来，稍等一会儿，我们再次执行 kubectl get pod，发现运行起来了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get pod
</span></span><span class="line"><span class="cl">NAME      READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">testapp   1/1     Running   0          2m29s
</span></span></code></pre></td></tr></table>
</div>
</div><p>命令行不方便管理，推荐使用 yaml 文件管理 pod，格式内容如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-pod
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  # 定义容器，可以多个
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: test-k8s # 容器名字
</span></span><span class="line"><span class="cl">      image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 # 镜像
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 kubectl apply -f 命令，应用该 yaml 文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f pod.yaml 
</span></span><span class="line"><span class="cl">pod/test-pod created
</span></span><span class="line"><span class="cl">$ kubectl get pod
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">test-pod   1/1     Running   0          7s
</span></span><span class="line"><span class="cl">testapp    1/1     Running   0          4m22s
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是 yaml 直接配置 pod 不方便伸缩扩容，所以还要 Deployment 上场！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s # 部署名字
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 2 # 扩容副本数量
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  selector: # 用来查找关联的 Pod，所有标签都匹配才行
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: test-k8s
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  template: # 定义 Pod 相关数据
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: test-k8s
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      # 定义容器，可以多个
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: test-k8s # 容器名字
</span></span><span class="line"><span class="cl">        image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 # 镜像
</span></span></code></pre></td></tr></table>
</div>
</div><p>部署起来</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f app.yaml 
</span></span><span class="line"><span class="cl">deployment.apps/test-k8s created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get deployments
</span></span><span class="line"><span class="cl">NAME       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">test-k8s   2/2     2            2           24s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pod -o wide
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-54r85   1/1     Running   0          86s     172.18.0.5   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-mlgbr   1/1     Running   0          86s     172.18.0.6   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-pod                    1/1     Running   0          6m32s   172.18.0.4   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">testapp                     1/1     Running   0          10m     172.18.0.3   minikube   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Deployment 通过 label 关联起来 Pods</strong></p>
<p><img src="/img/k8s_4.png" alt=""></p>
<p>查看 pod 的详细信息，pod 被调度通知 minikube，然后 kubelet 下载容器、创建容器、启动容器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl describe pod test-k8s-68bb74d654-54r85
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason     Age   From               Message
</span></span><span class="line"><span class="cl">  ----    ------     ----  ----               -------
</span></span><span class="line"><span class="cl">  Normal  Scheduled  19m   default-scheduler  Successfully assigned default/test-k8s-68bb74d654-54r85 to minikube
</span></span><span class="line"><span class="cl">  Normal  Pulled     19m   kubelet            Container image &#34;ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1&#34; already present on machine
</span></span><span class="line"><span class="cl">  Normal  Created    19m   kubelet            Created container test-k8s
</span></span><span class="line"><span class="cl">  Normal  Started    19m   kubelet            Started container test-k8s
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 pod 的日志，可以看到 pod 监听本地 8080 TCP 端口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl logs test-k8s-68bb74d654-54r85
</span></span><span class="line"><span class="cl">[2022-06-22T11:16:47.006] [INFO] app - run in docker
</span></span><span class="line"><span class="cl">[2022-06-22T11:16:47.017] [INFO] app - Server started successfully and listened on 8080
</span></span><span class="line"><span class="cl">http://localhost:8080
</span></span></code></pre></td></tr></table>
</div>
</div><p>如何进入 pod 容器里面呢？</p>
<ul>
<li>kubectl exec -it pod-name &ndash; bash # 进入 Pod 容器终端</li>
<li>kubectl exec -it -c container-name pod-name &ndash; bash  # 当 pod 里有多个容器时，指定进入 某个容器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl exec -it test-k8s-68bb74d654-54r85 -- bash
</span></span><span class="line"><span class="cl">root@test-k8s-68bb74d654-54r85:/app# ss -tunlp
</span></span><span class="line"><span class="cl">Netid State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port              
</span></span><span class="line"><span class="cl">tcp   LISTEN     0      128                        :::8080                                   :::*                   users:((&#34;node&#34;,pid=7,fd=22))
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们修改 app.yaml 文件，把 test-k8s pod 扩容到 5 node，并重新应用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f app.yaml 
</span></span><span class="line"><span class="cl">deployment.apps/test-k8s configured
</span></span></code></pre></td></tr></table>
</div>
</div><p>重新查看 pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get pod -o wide
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-54r85   1/1     Running   0          30m   172.18.0.5   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-d94cl   1/1     Running   0          57s   172.18.0.8   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-m5fvw   1/1     Running   0          57s   172.18.0.9   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-mlgbr   1/1     Running   0          30m   172.18.0.6   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-qznxz   1/1     Running   0          57s   172.18.0.7   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-pod                    1/1     Running   0          35m   172.18.0.4   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">testapp                     1/1     Running   0          40m   172.18.0.3   minikube   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>重新查看 deployment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get deployment 
</span></span><span class="line"><span class="cl">NAME       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">test-k8s   5/5     5            5           31m
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们也可以通过 kubectl 命令行伸缩 pod 数量，而不需要改动 app.yaml 文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl scale deployment test-k8s --replicas=10
</span></span><span class="line"><span class="cl">deployment.apps/test-k8s scaled
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次查看 test-k8s pod，发现数量增加至 10 了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get pod -o wide
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-54r85   1/1     Running   0          34m     172.18.0.5    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-b7zbr   1/1     Running   0          19s     172.18.0.13   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-c5gbh   1/1     Running   0          19s     172.18.0.10   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-d94cl   1/1     Running   0          4m34s   172.18.0.8    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-hqhbs   1/1     Running   0          19s     172.18.0.14   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-m5fvw   1/1     Running   0          4m34s   172.18.0.9    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-mlgbr   1/1     Running   0          34m     172.18.0.6    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-qznxz   1/1     Running   0          4m34s   172.18.0.7    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-w4hcg   1/1     Running   0          19s     172.18.0.12   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-wc5ks   1/1     Running   0          19s     172.18.0.11   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-pod                    1/1     Running   0          39m     172.18.0.4    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">testapp                     1/1     Running   0          43m     172.18.0.3    minikube   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着再把 pod 数量缩容至 2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl scale deployment test-k8s --replicas=2
</span></span><span class="line"><span class="cl">$ kubectl get pod -o wide
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS        RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-54r85   1/1     Running       0          36m     172.18.0.5    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-b7zbr   1/1     Terminating   0          2m35s   172.18.0.13   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-c5gbh   1/1     Terminating   0          2m35s   172.18.0.10   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-d94cl   1/1     Terminating   0          6m50s   172.18.0.8    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-hqhbs   1/1     Terminating   0          2m35s   172.18.0.14   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-m5fvw   1/1     Terminating   0          6m50s   172.18.0.9    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-mlgbr   1/1     Running       0          36m     172.18.0.6    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-qznxz   1/1     Terminating   0          6m50s   172.18.0.7    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-w4hcg   1/1     Terminating   0          2m35s   172.18.0.12   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-k8s-68bb74d654-wc5ks   1/1     Terminating   0          2m35s   172.18.0.11   minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">test-pod                    1/1     Running       0          41m     172.18.0.4    minikube   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">testapp                     1/1     Running       0          45m     172.18.0.3    minikube   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>所有 pod 的服务都是在容器内部，若想让外部访问，还要做端口映射。（要一直开着转发程序，不能退出）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl port-forward test-k8s-68bb74d654-mlgbr 8090:8080
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:8090 -&gt; 8080
</span></span><span class="line"><span class="cl">Forwarding from [::1]:8090 -&gt; 8080
</span></span><span class="line"><span class="cl">Handling connection for 8090
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看当前机器监听的 8090 端口，并用 curl 请求 HTTP index 页面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ss -tnlp
</span></span><span class="line"><span class="cl">State  Recv-Q   Send-Q      Local Address:Port      Peer Address:Port            
</span></span><span class="line"><span class="cl">LISTEN 0        128             127.0.0.1:8090           0.0.0.0:*      users:((&#34;kubectl&#34;,pid=18323,fd=8))        
</span></span><span class="line"><span class="cl">LISTEN 0        128                 [::1]:8090              [::]:*      users:((&#34;kubectl&#34;,pid=18323,fd=9))  
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">$ curl http://127.0.0.1:8090
</span></span><span class="line"><span class="cl">index page 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IP lo172.18.0.6, hostname: test-k8s-68bb74d654-mlgbr
</span></span></code></pre></td></tr></table>
</div>
</div><p>还可以持续看 pod 里面服务的运行日志（其实显示的就是程序的标准输出）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl logs test-k8s-68bb74d654-mlgbr -f
</span></span><span class="line"><span class="cl">[2022-06-22T11:16:47.036] [INFO] app - run in docker
</span></span><span class="line"><span class="cl">[2022-06-22T11:16:47.044] [INFO] app - Server started successfully and listened on 8080
</span></span><span class="line"><span class="cl">http://localhost:8080
</span></span><span class="line"><span class="cl">[2022-06-22T11:56:59.540] [INFO] app - on index page
</span></span><span class="line"><span class="cl">[2022-06-22T11:59:14.677] [INFO] app - on index page
</span></span><span class="line"><span class="cl">[2022-06-22T11:59:24.384] [INFO] app - on index page
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pod--deployment-管理命令">pod &amp; deployment 管理命令</h2>
<p>基础命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 部署应用
</span></span><span class="line"><span class="cl">kubectl apply -f app.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 deployment
</span></span><span class="line"><span class="cl">kubectl get deployment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 pod
</span></span><span class="line"><span class="cl">kubectl get pod -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 pod 详情
</span></span><span class="line"><span class="cl">kubectl describe pod pod-name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 log
</span></span><span class="line"><span class="cl">kubectl logs pod-name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入 Pod 容器终端， -c container-name 可以指定进入哪个容器。
</span></span><span class="line"><span class="cl">kubectl exec -it pod-name -- bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 伸缩扩展副本
</span></span><span class="line"><span class="cl">kubectl scale deployment test-k8s --replicas=5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 把集群内端口映射到节点
</span></span><span class="line"><span class="cl">kubectl port-forward pod-name 8090:8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 deployment 修改历史
</span></span><span class="line"><span class="cl">kubectl rollout history deployment test-k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 回到上个 deployment 版本
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment test-k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 回到指定 deployment 版本
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment test-k8s --to-revision=2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除部署 deployment
</span></span><span class="line"><span class="cl">kubectl delete deployment test-k8s
</span></span></code></pre></td></tr></table>
</div>
</div><p>更多命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看全部
</span></span><span class="line"><span class="cl">kubectl get all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 重新部署
</span></span><span class="line"><span class="cl">kubectl rollout restart deployment test-k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 命令修改镜像，test-k8s 是容器名字，等号后面是镜像地址
</span></span><span class="line"><span class="cl"># --record 表示把这个命令记录到操作历史中
</span></span><span class="line"><span class="cl">kubectl set image deployment test-k8s test-k8s=ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v2-with-error --record
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 暂停运行，暂停后，对 deployment 的修改不会立刻生效，恢复后才应用设置
</span></span><span class="line"><span class="cl">kubectl rollout pause deployment test-k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 恢复运行
</span></span><span class="line"><span class="cl">kubectl rollout resume deployment test-k8s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看 deployment 的配置信息，并输出到文件
</span></span><span class="line"><span class="cl"># -o 除了可以指定 yaml 格式，还可以指定 json 格式
</span></span><span class="line"><span class="cl">kubectl get deployment test-k8s -o yaml &gt;&gt; app2.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除全部资源
</span></span><span class="line"><span class="cl">kubectl delete all --all
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="service-管理命令">service 管理命令</h2>
<p>如果要在集群外部访问 service，可以通过端口转发实现（只适合临时测试用）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl port-forward service/test-k8s 8888:8080
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pod--deployment--statefulset-的关系">Pod &amp; Deployment &amp; StatefulSet 的关系</h2>
<p>Pod 是单一亦或一组容器的合集，Pod 是 k8s 的最小调度单位，一个 Pod 中可以有多个 containers，彼此共享网络。</p>
<p>从开发者角度看，deployment 顾明思意，既部署，对于完整的应用部署流程，除了运行代码（既 pod）之外，需要考虑更新策略，副本数量，回滚，重启等步骤，</p>
<ul>
<li>deployment，StatefulSet 是 Controller，保证 Pod 一直运行在你需要的状态。</li>
<li>有一次性的也就是job，有定时执行的也就是crontabjob，有排号的也就是sts</li>
<li>任何的控制器单位的具体实现必须落到 Pod 去实现。</li>
</ul>
<p>参考：</p>
<ul>
<li>[kubernetes（k8s）StatefulSet 和 Deployment 区别及选择方式] <a href="https://blog.csdn.net/nickDaDa/article/details/90401635">https://blog.csdn.net/nickDaDa/article/details/90401635</a></li>
</ul>
<h1 id="资源-yaml-文件编写说明">资源 yaml 文件编写说明</h1>
<p>我们编写好资源 yaml 文件后，可以通过 kubectl apply -f resource.yaml 命令应用资源。</p>
<h2 id="pod-资源">Pod 资源</h2>
<p>运行一个 Pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-pod
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  # 定义容器，可以多个
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: test-k8s # 容器名字
</span></span><span class="line"><span class="cl">      image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 # 镜像
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行一个 Pod，运行到拥有 ssd 固态磁盘的节点上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: nginx
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    env: test
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: nginx
</span></span><span class="line"><span class="cl">    image: nginx
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">  nodeSelector:
</span></span><span class="line"><span class="cl">    disktype: ssd
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="deployment-资源">Deployment 资源</h2>
<p>适合无状态（Stateless）应用。所有 pod 等价，可替代。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  # 部署名字
</span></span><span class="line"><span class="cl">  name: test-k8s
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 2
</span></span><span class="line"><span class="cl">  # 用来查找关联的 Pod，所有标签都匹配才行
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: test-k8s
</span></span><span class="line"><span class="cl">  # 定义 Pod 相关数据
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: test-k8s
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      # 定义容器，可以多个
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: test-k8s # 容器名字
</span></span><span class="line"><span class="cl">        image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 # 镜像
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="statefulset-资源">StatefulSet 资源</h2>
<p>前面我们部署的应用，都是不需要存储数据，不需要记住状态的，可以随意扩充副本，每个副本都是一样的，可替代的。</p>
<p>StatefulSet 是用来管理有状态的应用，例如数据库。而像数据库、Redis 这类有状态的，则不能随意扩充副本。并且会固定每个 Pod 的名字。</p>
<p>StatefulSet 特性</p>
<ul>
<li>Service 的 CLUSTER-IP 是空的，Pod 名字也是固定的。</li>
<li>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。</li>
<li>Pod 重建不会改变名字，除了IP，所以不要用IP直连</li>
</ul>
<p><strong>部署 StatefulSet 类型的 Mongodb</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: StatefulSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  serviceName: mongodb
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: mongodb
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: mongodb
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">        - name: mongo
</span></span><span class="line"><span class="cl">          image: mongo:4.4
</span></span><span class="line"><span class="cl">          # IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错
</span></span><span class="line"><span class="cl">          imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: mongodb
</span></span><span class="line"><span class="cl">  type: ClusterIP
</span></span><span class="line"><span class="cl">  # HeadLess，不会分配集群 ip，只能通过服务名字访问
</span></span><span class="line"><span class="cl">  clusterIP: None
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 27017
</span></span><span class="line"><span class="cl">      targetPort: 27017
</span></span></code></pre></td></tr></table>
</div>
</div><p>kubectl apply -f mongo.yaml</p>
<p><img src="/img/k8s_6.png" alt=""></p>
<h3 id="数据持久化-hostpath-不推荐使用">数据持久化 HostPath 不推荐使用</h3>
<p>kubernetes 集群不会为你处理数据的存储，我们可以为数据库挂载一个磁盘来确保数据的安全。
你可以选择云存储、本地磁盘、NFS。</p>
<ul>
<li>本地磁盘：可以挂载某个节点上的目录，但是这需要限定 pod 在这个节点上运行</li>
<li>云存储：不限定节点，不受集群影响，安全稳定；需要云服务商提供，裸机集群是没有的。</li>
<li>NFS：不限定节点，不受集群影响</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: StatefulSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 1
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: mongodb
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: mongodb
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">        - name: mongo
</span></span><span class="line"><span class="cl">          image: mongo:4.4
</span></span><span class="line"><span class="cl">          # IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错
</span></span><span class="line"><span class="cl">          imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">          volumeMounts:
</span></span><span class="line"><span class="cl">            - mountPath: /data/db # 容器里面的挂载路径
</span></span><span class="line"><span class="cl">              name: mongo-data    # 卷名字，必须跟下面定义的名字一致
</span></span><span class="line"><span class="cl">      volumes:
</span></span><span class="line"><span class="cl">        - name: mongo-data              # 卷名字
</span></span><span class="line"><span class="cl">          hostPath:
</span></span><span class="line"><span class="cl">            path: /data/mongo-data      # 节点上的路径
</span></span><span class="line"><span class="cl">            type: DirectoryOrCreate     # 指向一个目录，不存在时自动创建
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">        - name: mongo-data2
</span></span><span class="line"><span class="cl">          hostPath:
</span></span><span class="line"><span class="cl">            PersistentVolumeClaim:
</span></span><span class="line"><span class="cl">				claimName: mongodata    # PVC 申请单的名字
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>更高级的抽象</strong></p>
<p><img src="/img/k8s_7.png" alt=""></p>
<h3 id="storage-class-sc">Storage Class (SC)</h3>
<p>将存储卷划分为不同的种类，例如：SSD，普通磁盘，本地磁盘，按需使用。<a href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">文档</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: storage.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: StorageClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: slow
</span></span><span class="line"><span class="cl">provisioner: kubernetes.io/aws-ebs
</span></span><span class="line"><span class="cl">parameters:
</span></span><span class="line"><span class="cl">  type: io1
</span></span><span class="line"><span class="cl">  iopsPerGB: &#34;10&#34;
</span></span><span class="line"><span class="cl">  fsType: ext4
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="persistent-volume-pv">Persistent Volume (PV)</h3>
<p>描述卷的具体信息，例如：</p>
<ul>
<li>磁盘大小</li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#access-modes">访问模式</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">文档</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">类型</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">Local 示例</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodata
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  capacity:
</span></span><span class="line"><span class="cl">    storage: 2Gi
</span></span><span class="line"><span class="cl">  volumeMode: Filesystem  # Filesystem（文件系统） Block（块）
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteOnce       # 卷可以被一个节点以读写方式挂载
</span></span><span class="line"><span class="cl">  persistentVolumeReclaimPolicy: Delete
</span></span><span class="line"><span class="cl">  storageClassName: local-storage
</span></span><span class="line"><span class="cl">  local:
</span></span><span class="line"><span class="cl">    path: /root/data
</span></span><span class="line"><span class="cl">  nodeAffinity:
</span></span><span class="line"><span class="cl">    required:
</span></span><span class="line"><span class="cl">      # 通过 hostname 限定在某个节点创建存储卷
</span></span><span class="line"><span class="cl">      nodeSelectorTerms:
</span></span><span class="line"><span class="cl">        - matchExpressions:
</span></span><span class="line"><span class="cl">            - key: kubernetes.io/hostname
</span></span><span class="line"><span class="cl">              operator: In
</span></span><span class="line"><span class="cl">              values:
</span></span><span class="line"><span class="cl">                - node2
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="persistent-volume-claim-pvc-申请单">Persistent Volume Claim (PVC) 申请单</h3>
<p>对存储需求的一个申明，可以理解为一个申请单，系统根据这个申请单去找一个合适的 PV</p>
<p>还可以根据 PVC 自动创建 PV。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolumeClaim
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodata
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteOnce&#34;]
</span></span><span class="line"><span class="cl">  storageClassName: &#34;local-storage&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">    requests:
</span></span><span class="line"><span class="cl">      storage: 2Gi
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>为什么要这么多层抽象？</strong></p>
<ul>
<li>更好的分工，运维人员负责提供好存储，开发人员不需要关注磁盘细节，只需要写一个申请单。</li>
<li>方便云服务商提供不同类型的，配置细节不需要开发者关注，只需要一个申请单。</li>
<li><a href="https://kubernetes.io/zh/docs/concepts/storage/dynamic-provisioning/">动态创建</a>，开发人员写好申请单后，供应商可以根据需求自动创建所需存储卷。</li>
</ul>
<h3 id="本地磁盘示例">本地磁盘示例</h3>
<p>不支持动态创建，需要提前创建好</p>
<p>mongo.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: StatefulSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  serviceName: &#34;mongo&#34; # 为 Headless Service 的名字
</span></span><span class="line"><span class="cl">  replicas: 1
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: mongodb
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: mongodb
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">        - name: mongo
</span></span><span class="line"><span class="cl">          image: &#39;mongo:4.4&#39;
</span></span><span class="line"><span class="cl">          imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">          volumeMounts:
</span></span><span class="line"><span class="cl">            - mountPath: /data/db
</span></span><span class="line"><span class="cl">              name: mongo-data
</span></span><span class="line"><span class="cl">      volumes:
</span></span><span class="line"><span class="cl">        - name: mongo-data
</span></span><span class="line"><span class="cl">          persistentVolumeClaim:
</span></span><span class="line"><span class="cl">            claimName: mongodata
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  type: ClusterIP
</span></span><span class="line"><span class="cl">  clusterIP: None
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 27017
</span></span><span class="line"><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="cl">      targetPort: 27017
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: mongodb
</span></span></code></pre></td></tr></table>
</div>
</div><p>sc.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: storage.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: StorageClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: local-storage
</span></span><span class="line"><span class="cl">provisioner: kubernetes.io/no-provisioner
</span></span><span class="line"><span class="cl">volumeBindingMode: WaitForFirstConsumer
</span></span></code></pre></td></tr></table>
</div>
</div><p>pv.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodata
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  capacity:
</span></span><span class="line"><span class="cl">    storage: 2Gi
</span></span><span class="line"><span class="cl">  volumeMode: Filesystem  # Filesystem（文件系统） Block（块）
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteOnce       # 卷可以被一个节点以读写方式挂载
</span></span><span class="line"><span class="cl">  persistentVolumeReclaimPolicy: Delete
</span></span><span class="line"><span class="cl">  storageClassName: local-storage
</span></span><span class="line"><span class="cl">  local:
</span></span><span class="line"><span class="cl">    path: /root/data
</span></span><span class="line"><span class="cl">  nodeAffinity:
</span></span><span class="line"><span class="cl">    required:
</span></span><span class="line"><span class="cl">      # 通过 hostname 限定在某个节点创建存储卷
</span></span><span class="line"><span class="cl">      nodeSelectorTerms:
</span></span><span class="line"><span class="cl">        - matchExpressions:
</span></span><span class="line"><span class="cl">            - key: kubernetes.io/hostname
</span></span><span class="line"><span class="cl">              operator: In
</span></span><span class="line"><span class="cl">              values:
</span></span><span class="line"><span class="cl">                - minikube
</span></span></code></pre></td></tr></table>
</div>
</div><p>pvc.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolumeClaim
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodata
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteOnce&#34;]
</span></span><span class="line"><span class="cl">  storageClassName: &#34;local-storage&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">    requests:
</span></span><span class="line"><span class="cl">      storage: 2Gi
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看当前 k8s 集群有哪些节点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ hostname
</span></span><span class="line"><span class="cl">minikube
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME       STATUS   ROLES                  AGE   VERSION
</span></span><span class="line"><span class="cl">minikube   Ready    control-plane,master   33s   v1.20.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 storage class 并查看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f sc.yaml 
</span></span><span class="line"><span class="cl">storageclass.storage.k8s.io/local-storage created
</span></span><span class="line"><span class="cl">$ kubectl get sc
</span></span><span class="line"><span class="cl">NAME                 PROVISIONER                    RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
</span></span><span class="line"><span class="cl">local-storage        kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  10s
</span></span><span class="line"><span class="cl">standard (default)   k8s.io/minikube-hostpath       Delete          Immediate              false                  2m36s
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 Persistent Volume 并查看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f pv.yaml 
</span></span><span class="line"><span class="cl">persistentvolume/mongodata created
</span></span><span class="line"><span class="cl">$ kubectl get pv
</span></span><span class="line"><span class="cl">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE
</span></span><span class="line"><span class="cl">mongodata   2Gi        RWO            Delete           Available           local-storage            9s
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 Persistent Volume Claim 申请单并查看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f pvc.yaml 
</span></span><span class="line"><span class="cl">persistentvolumeclaim/mongodata created
</span></span><span class="line"><span class="cl">$ kubectl get pvc
</span></span><span class="line"><span class="cl">NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span class="line"><span class="cl">mongodata   Pending                                      local-storage   6s
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 mongodb 并查看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f mongo.yaml --validate=false
</span></span><span class="line"><span class="cl">statefulset.apps/mongodb created
</span></span><span class="line"><span class="cl">service/mongodb created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pod
</span></span><span class="line"><span class="cl">NAME        READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">mongodb-0   0/1     ContainerCreating   0          48s
</span></span><span class="line"><span class="cl">$ kubectl get statefulset
</span></span><span class="line"><span class="cl">NAME      READY   AGE
</span></span><span class="line"><span class="cl">mongodb   0/1     48s
</span></span><span class="line"><span class="cl">$ kubectl get pvc
</span></span><span class="line"><span class="cl">NAME        STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span class="line"><span class="cl">mongodata   Bound    mongodata   2Gi        RWO            local-storage   11m
</span></span></code></pre></td></tr></table>
</div>
</div><p>但我在 minikube 上启动 mongodb 却失败了。原因是提示我 /root/data 目录不存在。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl describe pod mongodb-0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason       Age                   From               Message
</span></span><span class="line"><span class="cl">  ----     ------       ----                  ----               -------
</span></span><span class="line"><span class="cl">  Normal   Scheduled    5m42s                 default-scheduler  Successfully assigned default/mongodb-0 to minikube
</span></span><span class="line"><span class="cl">  Warning  FailedMount  92s (x10 over 5m42s)  kubelet            MountVolume.NewMounter initialization failed for volume &#34;mongodata&#34; : path &#34;/root/data&#34; does not exist
</span></span><span class="line"><span class="cl">  Warning  FailedMount  81s (x2 over 3m39s)   kubelet            Unable to attach or mount volumes: unmounted volumes=[mongo-data], unattached volumes=[mongo-data default-token-6mq8l]: timed out waiting for the condition
</span></span><span class="line"><span class="cl">$ 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="daemonset-资源">DaemonSet 资源</h2>
<p>在每个节点上跑一个 Pod，可以用来做节点监控、节点日志收集等</p>
<h2 id="job--cronjob-资源">Job &amp; CronJob 资源</h2>
<p>Job 用来表达的是一次性的任务，而 CronJob 会根据其时间规划反复运行。</p>
<h2 id="service-资源">Service 资源</h2>
<ul>
<li>Service 通过 label 关联对应的 Pod</li>
<li>Servcie 生命周期不跟 Pod 绑定，不会因为 Pod 重创改变 IP</li>
<li>提供了负载均衡功能，自动转发流量到不同 Pod</li>
<li>可对集群外部提供访问端口</li>
<li>集群内部可通过服务名字访问</li>
</ul>
<p><img src="/img/k8s_5.png" alt=""></p>
<p>创建一个 Service，通过标签 test-k8s 跟对应的 Pod 关联上</p>
<p><strong>ClusterIP 默认类型</strong>，只能集群内部访问。也就是只能在 pod 里面访问。外部访问需要用 kubectl port-forward service/test-k8s 8888:8080 做转口转发。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s # Service 名称
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: test-k8s # 标签关联 pod
</span></span><span class="line"><span class="cl">  type: ClusterIP # Service 类型
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 8080        # 本 Service 的端口
</span></span><span class="line"><span class="cl">      targetPort: 8080  # 容器端口
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NodePort 类型</strong>，可以直接把集群容器服务暴露出来。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s # Service 名称
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: test-k8s # 标签关联 pod	
</span></span><span class="line"><span class="cl">  type: ClusterIP # 默认 ClusterIP 集群内可访问，NodePort 节点可访问，LoadBalancer 负载均衡模式（需要负载均衡器才可用）
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 8080        # 本 Service 的端口
</span></span><span class="line"><span class="cl">      targetPort: 8080  # 容器端口
</span></span><span class="line"><span class="cl">	  nodePort:31000    # 节点端口，范围固定 30000 ~ 32767
</span></span></code></pre></td></tr></table>
</div>
</div><p>多端口时必须配置 name</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: test-k8s
</span></span><span class="line"><span class="cl">  type: NodePort
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 8080        # 本 Service 的端口
</span></span><span class="line"><span class="cl">      name: test-k8s    # 必须配置
</span></span><span class="line"><span class="cl">      targetPort: 8080  # 容器端口
</span></span><span class="line"><span class="cl">      nodePort: 31000   # 节点端口，范围固定 30000 ~ 32767
</span></span><span class="line"><span class="cl">    - port: 8090
</span></span><span class="line"><span class="cl">      name: test-other
</span></span><span class="line"><span class="cl">      targetPort: 8090
</span></span><span class="line"><span class="cl">      nodePort: 32000
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>LoadBalancer 类型</strong> 也可以对外提供服务，但需要一个负载均衡器的支持（一般需要云服务商提供），因为它需要生成一个新的 IP 对外服务，否则状态就一直是 pendding，这个很少用了，后面我们会讲更高端的 Ingress 来代替它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s # Service 名称
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: test-k8s    # 标签关联 pod
</span></span><span class="line"><span class="cl">  type: LoadBalancer # Service 类型
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 8080        # 本 Service 的端口
</span></span><span class="line"><span class="cl">      targetPort: 8080  # 容器端口
</span></span><span class="line"><span class="cl">      nodePort: 31000   # 节点端口，范围固定 30000 ~ 32767
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们应用它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f service.yaml 
</span></span><span class="line"><span class="cl">service/test-k8s created
</span></span><span class="line"><span class="cl">$ kubectl get service
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    18m
</span></span><span class="line"><span class="cl">test-k8s     ClusterIP   10.100.85.178   &lt;none&gt;        8080/TCP   4s
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，还有一个 <strong>Headless Service</strong> 无头服务配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: test-k8s # Service 名称
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: test-k8s # 标签关联 pod
</span></span><span class="line"><span class="cl">  type: ClusterIP # Service 类型
</span></span><span class="line"><span class="cl">  ClusterIP: none # Headless，不会分配集群 ip，只能通过服务名字访问
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: 8080        # 本 Service 的端口
</span></span><span class="line"><span class="cl">      targetPort: 8080  # 容器端口
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后我们访问服务方式就变成两种：</p>
<ul>
<li>随机访问 service 下的 pod： curl http://test-k8s:443</li>
<li>固定访问 service 下的某个 pod： curl <a href="http://mongod-01.test">http://mongod-01.test</a>-k8s:443</li>
</ul>
<h2 id="configmap--secret-资源">ConfigMap &amp; Secret 资源</h2>
<p>数据库连接地址，这种可能根据部署环境变化的，我们不应该写死在代码里。</p>
<p>Kubernetes 为我们提供了 <strong>ConfigMap</strong>，可以方便的配置一些变量。<a href="https://kubernetes.io/zh/docs/concepts/configuration/configmap/">文档</a></p>
<p>configmap.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongo-config
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  mongoHost: mongodb-0.mongodb
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mongoHost 填写格式：pod-name.service-name</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 应用
</span></span><span class="line"><span class="cl">$ kubectl apply -f configmap.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">$ kubectl get configmap mongo-config -o yaml
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongo-config
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  mongoHost: mongodb-0.mongodb
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Secret</strong></p>
<p>一些重要数据，例如密码、TOKEN，我们可以放到 secret 中。文档，配置证书</p>
<blockquote>
<p>注意，数据要进行 Base64 编码。<a href="https://tools.fun/base64.html">Base64 工具</a></p>
</blockquote>
<p>secret.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongo-secret
</span></span><span class="line"><span class="cl"># Opaque 用户定义的任意数据，更多类型介绍 https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types
</span></span><span class="line"><span class="cl">type: Opaque
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  # 数据要 base64。https://tools.fun/base64.html
</span></span><span class="line"><span class="cl">  mongo-username: bW9uZ291c2Vy
</span></span><span class="line"><span class="cl">  mongo-password: bW9uZ29wYXNz
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 应用
</span></span><span class="line"><span class="cl">$ kubectl apply -f secret.yaml
</span></span><span class="line"><span class="cl">secret/mongo-secret created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">$ kubectl get secret mongo-secret -o yaml
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  mongo-password: bW9uZ29wYXNz
</span></span><span class="line"><span class="cl">  mongo-username: bW9uZ291c2Vy
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="作为环境变量使用">作为环境变量使用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: StatefulSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mongodb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: mongodb
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: mongodb
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">        - name: mongo
</span></span><span class="line"><span class="cl">          image: mongo:4.4
</span></span><span class="line"><span class="cl">          # IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错
</span></span><span class="line"><span class="cl">          imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">          env:
</span></span><span class="line"><span class="cl">          - name: MONGO_INITDB_ROOT_USERNAME
</span></span><span class="line"><span class="cl">            valueFrom:
</span></span><span class="line"><span class="cl">              secretKeyRef:
</span></span><span class="line"><span class="cl">                name: mongo-secret
</span></span><span class="line"><span class="cl">                key: mongo-username
</span></span><span class="line"><span class="cl">          - name: MONGO_INITDB_ROOT_PASSWORD
</span></span><span class="line"><span class="cl">            valueFrom:
</span></span><span class="line"><span class="cl">              secretKeyRef:
</span></span><span class="line"><span class="cl">                name: mongo-secret
</span></span><span class="line"><span class="cl">                key: mongo-password
</span></span><span class="line"><span class="cl">          # Secret 的所有数据定义为容器的环境变量，Secret 中的键名称为 Pod 中的环境变量名称
</span></span><span class="line"><span class="cl">          # envFrom:
</span></span><span class="line"><span class="cl">          # - secretRef:
</span></span><span class="line"><span class="cl">          #     name: mongo-secret
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="挂载为文件更适合证书文件">挂载为文件（更适合证书文件）</h3>
<p>挂载后，会在容器中对应路径生成文件，一个 key 一个文件，内容就是 value，<a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">文档</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mypod
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: mypod
</span></span><span class="line"><span class="cl">    image: redis
</span></span><span class="line"><span class="cl">    volumeMounts:
</span></span><span class="line"><span class="cl">    - name: foo
</span></span><span class="line"><span class="cl">      mountPath: &#34;/etc/foo&#34;
</span></span><span class="line"><span class="cl">      readOnly: true
</span></span><span class="line"><span class="cl">  volumes:
</span></span><span class="line"><span class="cl">  - name: foo
</span></span><span class="line"><span class="cl">    secret:
</span></span><span class="line"><span class="cl">      secretName: mysecret
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="helm--命名空间">Helm &amp; 命名空间</h2>
<p>Helm类似 npm，pip，docker hub, 可以理解为是一个软件库，可以方便快速的为我们的集群安装一些第三方软件。</p>
<p>使用 Helm 我们可以非常方便的就搭建出来 MongoDB / MySQL 主从副本集群，YAML 文件别人都给我们写好了，直接使用。</p>
<ul>
<li>官网 <a href="https://helm.sh/zh/">https://helm.sh/zh/</a></li>
<li>应用中心 <a href="https://artifacthub.io/">https://artifacthub.io/</a></li>
<li>helm 安装文档 <a href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装 mongodb 示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 安装
</span></span><span class="line"><span class="cl">helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span class="line"><span class="cl">helm install my-mongo bitnami/mongodb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 指定密码和架构
</span></span><span class="line"><span class="cl">helm install my-mongo bitnami/mongodb --set architecture=&#34;replicaset&#34;,auth.rootPassword=&#34;mongopass&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除
</span></span><span class="line"><span class="cl">helm ls
</span></span><span class="line"><span class="cl">heml delete my-mongo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看密码
</span></span><span class="line"><span class="cl">kubectl get secret my-mongo-mongodb -o json
</span></span><span class="line"><span class="cl">kubectl get secret my-mongo-mongodb -o yaml &gt; secret.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 临时运行一个包含 mongo client 的 debian 系统
</span></span><span class="line"><span class="cl">kubectl run mongodb-client --rm --tty -i --restart=&#39;Never&#39; --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --command -- bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进去 mongodb
</span></span><span class="line"><span class="cl">mongo --host &#34;my-mongo-mongodb&#34; -u root -p mongopass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 也可以转发集群里的端口到宿主机访问 mongodb
</span></span><span class="line"><span class="cl">kubectl port-forward svc/my-mongo-mongodb 27017:27018
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>命名空间</strong></p>
<p>如果一个集群中部署了多个应用，所有应用都在一起，就不太好管理，也可以导致名字冲突等。</p>
<p>我们可以使用 namespace 把应用划分到不同的命名空间，跟代码里的 namespace 是一个概念，只是为了划分空间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 创建命名空间
</span></span><span class="line"><span class="cl">kubectl create namespace testapp
</span></span><span class="line"><span class="cl"># 部署应用到指定的命名空间
</span></span><span class="line"><span class="cl">kubectl apply -f app.yml --namespace testapp
</span></span><span class="line"><span class="cl"># 查询
</span></span><span class="line"><span class="cl">kubectl get pod --namespace kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以用 <a href="https://github.com/ahmetb/kubectx">kubens</a> 快速切换 namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 切换命名空间
</span></span><span class="line"><span class="cl">kubens kube-system
</span></span><span class="line"><span class="cl"># 回到上个命名空间
</span></span><span class="line"><span class="cl">kubens -
</span></span><span class="line"><span class="cl"># 切换集群
</span></span><span class="line"><span class="cl">kubectx minikube
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/k8s_8.png" alt=""></p>
<h2 id="ingress-提供统一访问入口">Ingress 提供统一访问入口</h2>
<p>功能类似 Nginx，可以根据域名、路径把请求转发到不同的 Service。可以配置 https。</p>
<p><img src="/img/k8s_9.png" alt=""></p>
<p>使用</p>
<ul>
<li>要使用 Ingress，需要一个负载均衡器 + Ingress Controller</li>
<li>如果是裸机（bare metal) 搭建的集群，你需要自己安装一个负载均衡插件，可以安装 METALLB</li>
<li>如果是云服务商，会自动给你配置，否则你的外部 IP 会是 “pending” 状态，无法使用。</li>
<li>文档：<a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">Ingress</a></li>
<li>Minikube 中部署 Ingress Controller：<a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">nginx</a></li>
<li>Helm 安装： <a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">Nginx</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: simple-example
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ingressClassName: nginx
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: tools.fun
</span></span><span class="line"><span class="cl">    http:
</span></span><span class="line"><span class="cl">      paths:
</span></span><span class="line"><span class="cl">      - path: /easydoc
</span></span><span class="line"><span class="cl">        pathType: Prefix
</span></span><span class="line"><span class="cl">        backend:
</span></span><span class="line"><span class="cl">          service:
</span></span><span class="line"><span class="cl">            name: service1
</span></span><span class="line"><span class="cl">            port:
</span></span><span class="line"><span class="cl">              number: 4200
</span></span><span class="line"><span class="cl">      - path: /svnbucket
</span></span><span class="line"><span class="cl">        pathType: Prefix
</span></span><span class="line"><span class="cl">        backend:
</span></span><span class="line"><span class="cl">          service:
</span></span><span class="line"><span class="cl">            name: service2
</span></span><span class="line"><span class="cl">            port:
</span></span><span class="line"><span class="cl">              number: 8080
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/docker-%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Docker 命令学习笔记</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="http://blog.gongchang.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>olOwOlo</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js" integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js" integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js" integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.js" integrity="sha384-8748Vn52gHJYJI0XEuPB2QlPVNUkJlJn9tHqKec6J3q2r9l8fvRxrgn/E5ZHV0sP" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.css" integrity="sha384-6QbLKJMz5dS3adWSeINZe74uSydBGFbnzaAYmp+tKyq60S7H2p6V7g1TysM5lAaF" crossorigin="anonymous">



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
